#!/usr/bin/perl 

###################################################################################
#Script:   This script is reporting the startup and completion of url execution   #
#          for eput batch evaluation java program                                 #
#                                                                                 #
#Author:   Amer Khan                                                              #
#Revision:                                                                        #
#Date           Name            Description                                       #
#---------------------------------------------------------------------------------#
#Jul 21,08	Amer Khan       Originally created                                #
#                                                                                 #
#                                                                                 #
###################################################################################

open (PROD, "</opt/sybase/cron_scripts/passwords/check_prod");
while (<PROD>){
@prodline = split(/\t/, $_);
$prodline[1] =~ s/\n//g;
}
if ($prodline[1] eq "0" ){
print "standby server \n";
#        die "This is a stand by server\n"
}
use Sys::Hostname;
$prodserver = hostname();

#Setting Time
$currDate=localtime();
$currTime = localtime();
$startHour=sprintf('%02d',((localtime())[2]));
#$startHour=substr($currTime,0,4);
$startMin=sprintf('%02d',((localtime())[1]));

($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time);

$year += 1900;
$mon += 1;
$min -= 1; #Start from the previous minute

$mon=sprintf('%02d',$mon);
$mday=sprintf('%02d',$mday);

$logFile = "canpar_$year-$mon-$mday.log";

#Check if the process has started or completed
$processErrors=`grep -aP "started|completed" /opt/sybase/eput_eval_mount/$logFile`;
@procArray = split(/\n/,$processErrors);

#################################################
#Check if the process completed within a minute #
#as it will not be caught by the logic below,   #
#since the logic below only runs once per minute#
#################################################
$found = 0;
$not_found=0;
foreach(@procArray){
   if(/$year-$mon-$mday $hour:$min/ && /started|completed/ && /Parcel/){
      $found++;
   }else{
      $not_found++;
      }
}

print "Found: $found... Not Found: $not_found\n";

if ($found > 1){
      `/usr/sbin/sendmail -t -i <<EOF
To: CANPARDatabaseAdministratorsStaffList\@canpar.com
Subject: svp_url for parcel trigger completed...
==============================================
$procArray[$#procArray-1]
$procArray[$#procArray]
==============================================

EOF
`;
`touch /tmp/svp_p_completed`;
print "$procArray[$#procArray-1]\n$procArray[$#procArray]\n";
die "Process is already complete within a minute";
}

###################################################
#Check if the process did start but did not finish#
#within one minute, so we need keep looking for   #
#completion.                                      #
###################################################
if($procArray[$#procArray] =~ /started/i){
   print "$procArray[$#procArray]\n";
   if (-e "/tmp/svp_p_started"){}else{
      `/usr/sbin/sendmail -t -i <<EOF
To: CANPARDatabaseAdministratorsStaffList\@canpar.com 
Subject: svp_url for parcel trigger started... 
==============================================
$procArray[$#procArray]
==============================================

EOF
`;
      `touch /tmp/svp_p_started`;
      `rm /tmp/svp_p_completed`;
   }
}


if($procArray[$#procArray] =~ /completed/i){
if (-e "/tmp/svp_p_completed"){die "Process either has not started yet, or it is already finished";}
   `rm /tmp/svp_p_started`;
   `touch /tmp/svp_p_completed`;
   print "\nThere are message in the process!! ".$procArray[$#procArray]."\n";

      `/usr/sbin/sendmail -t -i <<EOF
To: CANPARDatabaseAdministratorsStaffList\@canpar.com
Subject: svp_url for parcel trigger completed...
==============================================
$procArray[$#procArray]
==============================================

EOF
`;
}


